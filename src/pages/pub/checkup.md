---
layout: '#layout/Publication.astro'
---
# Бэк для чекапа

## БД
```mermaid
erDiagram
  direction LR
  Submission {
    Int id PK
    Int author_id FK
    string project_1_name
    string project_1_description
    string project_1_role
    Int project_1_image FK
    string project_2_name
    string project_2_description
    string project_2_role
    Int project_2_image FK
    string project_3_name
    string project_3_description
    string project_3_role
    Int project_3_image FK
    enum status "draft | submitted"
  }

  Image {
    Int id PK
    string cloudinary_url
    string local_path
    enum status "uploaded | saved-locally | saved-cld | local-upload-failure | cld-upload-failure"
    string log "Во время загрузки картинки на сервер или клаудинари, сюда складывается лог событий"
    string error "Во время загрузки сюда складываются ошибки"
  }

  Submission ||--o| Image : "includes"

```

- Добавить сущности в призму
- Создать миграцию
- Показать Мише
- Запустить на dev
- profit

## Эндпоинты
### Черновик
- сохранить в бд состояние формы

### Сабмит
- обновить у записи все поля на то, что только что пришло с сервера
- поставить флаг "засабмичено"

### Загрузка картинки
*На протяжении всех процессов, вести лог в запись в **бд***

- создать запись в бд
- создать временный файл, использовать в качестве имени id из бд с префиксом
- вернуть на страницу id
- загрузить файл как и сейчас они грузятся
- поставить статус "сохранено локально"
- отдать ответ что успешно сохраено
- запустить в бэкграунде загрузку картинки в клаудинари
- после того как загрузилось в клаудинари, обновить статус в бд

#### JOB проверки картинок
- Найти файлы, которые успешно загрузились в CLD
- Удалить локальные файлы
- Найти файлы, загрузка которых провалилась
- Добавить в бд счетчик попыток
- Запустить загрузку картинки в CLD

## Изменение поведения
При загрузке формы,
- проверять залогинен ли пользователь.
- проверять статус записи в бд и не пускать на страницы формы, на которые нельзя.
Если заявки нет, показывать кнопку "начать заполнять анкету", это создает черновик и переправляет на страницу формы
Если заявка есть и она в статусе draft, показать форму
Если заявка есть и в статусе submitted, показать финальный экран
